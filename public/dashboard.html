<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fleek NPS Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--bg:#0c0c0c;--card:#161616;--border:#252525;--yellow:#F5C518;--red:#E8453C;--green:#3DD68C;--blue:#4B9EFF;--text:#f0f0f0;--muted:#888}
    body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh}
    
    /* TOPBAR */
    .topbar{background:#111;border-bottom:1px solid var(--border);padding:0 32px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:100}
    .brand{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;color:var(--yellow);letter-spacing:2px}
    .brand span{color:var(--text);margin-left:8px;font-size:1rem;font-family:'Syne',sans-serif;font-weight:600;opacity:0.6}
    .topbar-right{display:flex;align-items:center;gap:12px}
    .survey-link{background:var(--yellow);color:#0c0c0c;padding:8px 18px;border-radius:8px;font-weight:700;font-size:0.85rem;text-decoration:none;letter-spacing:0.5px}
    .survey-link:hover{opacity:0.85}
    .logout-btn{background:transparent;border:1px solid var(--border);color:var(--muted);padding:8px 18px;border-radius:8px;cursor:pointer;font-family:'Syne',sans-serif;font-size:0.85rem}
    .logout-btn:hover{border-color:var(--text);color:var(--text)}
    
    /* TABS */
    .tabs{display:flex;gap:4px;padding:24px 32px 0;border-bottom:1px solid var(--border);background:#111}
    .tab{padding:10px 20px;border-radius:8px 8px 0 0;background:transparent;border:none;color:var(--muted);font-family:'Syne',sans-serif;font-weight:700;font-size:0.88rem;cursor:pointer;transition:all 0.2s;border:1px solid transparent;border-bottom:none}
    .tab:hover{color:var(--text)}
    .tab.active{background:var(--bg);color:var(--yellow);border-color:var(--border)}
    
    /* MAIN */
    .main{padding:32px;max-width:1300px;margin:0 auto}
    .tab-content{display:none}.tab-content.active{display:block}
    
    /* STAT CARDS */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:28px}
    .stat{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:22px;position:relative;overflow:hidden}
    .stat::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
    .stat.nps::before{background:var(--yellow)}
    .stat.pro::before{background:var(--green)}
    .stat.pass::before{background:#F59E0B}
    .stat.det::before{background:var(--red)}
    .stat-label{font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px}
    .stat-value{font-family:'JetBrains Mono',monospace;font-size:2.4rem;font-weight:700;line-height:1}
    .stat.nps .stat-value{color:var(--yellow)}
    .stat.pro .stat-value{color:var(--green)}
    .stat.pass .stat-value{color:#F59E0B}
    .stat.det .stat-value{color:var(--red)}
    .stat-sub{color:var(--muted);font-size:0.78rem;margin-top:6px}
    
    /* CHARTS */
    .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}
    @media(max-width:900px){.charts-grid{grid-template-columns:1fr}}
    .chart-box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:24px}
    .chart-box h3{font-size:0.8rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:20px}
    
    /* PERIOD FILTER */
    .filter-bar{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap}
    .filter-bar label{color:var(--muted);font-size:0.82rem;font-weight:700;text-transform:uppercase;letter-spacing:1px}
    .filter-bar select{background:#1a1a1a;border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:8px;font-family:'Syne',sans-serif;font-size:0.88rem;outline:none}
    .filter-bar select:focus{border-color:var(--yellow)}
    .filter-bar select option{background:#111}
    
    /* TABLE */
    .table-box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:24px;overflow:auto}
    .table-box h3{font-size:0.8rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:16px;display:flex;align-items:center;gap:12px}
    table{width:100%;border-collapse:collapse;min-width:700px}
    th{text-align:left;font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);padding:10px 12px;border-bottom:1px solid var(--border)}
    td{padding:11px 12px;border-bottom:1px solid #1a1a1a;font-size:0.87rem;color:var(--text)}
    tr:last-child td{border-bottom:none}
    tr:hover td{background:#1a1a1a}
    .badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:0.72rem;font-weight:700;font-family:'JetBrains Mono',monospace}
    .badge.P{background:rgba(61,214,140,0.15);color:var(--green)}
    .badge.S{background:rgba(245,158,11,0.15);color:#F59E0B}
    .badge.D{background:rgba(232,69,60,0.15);color:var(--red)}
    .score-pill{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:8px;font-family:'JetBrains Mono',monospace;font-weight:700;font-size:0.9rem}
    .score-pill.P{background:rgba(61,214,140,0.15);color:var(--green)}
    .score-pill.S{background:rgba(245,158,11,0.15);color:#F59E0B}
    .score-pill.D{background:rgba(232,69,60,0.15);color:var(--red)}
    
    /* DEPT CARDS */
    .dept-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-bottom:28px}
    .dept-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px}
    .dept-name{font-weight:700;font-size:0.95rem;margin-bottom:4px}
    .dept-nps{font-family:'JetBrains Mono',monospace;font-size:1.8rem;font-weight:700;margin-bottom:8px}
    .dept-nps.positive{color:var(--green)}.dept-nps.zero{color:#F59E0B}.dept-nps.negative{color:var(--red)}
    .dept-bar-bg{height:6px;background:#1a1a1a;border-radius:3px;overflow:hidden}
    .dept-bar-fill{height:100%;border-radius:3px;transition:width 0.8s}
    .dept-meta{display:flex;justify-content:space-between;font-size:0.75rem;color:var(--muted);margin-top:8px}
    
    /* GEO CARDS */
    .geo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-bottom:28px}
    .geo-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:22px}
    .geo-flag{font-size:1.8rem;margin-bottom:8px}
    .geo-name{font-weight:800;font-size:1rem;margin-bottom:2px}
    .geo-nps{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:700}
    .geo-nps.positive{color:var(--green)}.geo-nps.zero{color:#F59E0B}.geo-nps.negative{color:var(--red)}
    .geo-segs{display:flex;gap:8px;margin-top:10px;font-size:0.75rem}
    .geo-seg{display:flex;flex-direction:column;align-items:center;background:#1a1a1a;border-radius:6px;padding:6px 10px;flex:1}
    .geo-seg .seg-label{color:var(--muted);font-size:0.65rem;text-transform:uppercase;letter-spacing:0.8px}
    .geo-seg .seg-val{font-family:'JetBrains Mono',monospace;font-size:0.95rem;font-weight:700;margin-top:2px}
    
    /* HISTORY TABLE */
    .history-table{width:100%;border-collapse:collapse}
    .history-table th{text-align:left;font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);padding:10px 16px;border-bottom:1px solid var(--border)}
    .history-table td{padding:14px 16px;border-bottom:1px solid #1a1a1a;font-size:0.9rem}
    .nps-trend{font-family:'JetBrains Mono',monospace;font-size:1.2rem;font-weight:700}
    .nps-trend.p{color:var(--green)}.nps-trend.z{color:#F59E0B}.nps-trend.n{color:var(--red)}
    .delta-chip{font-size:0.75rem;padding:2px 8px;border-radius:12px;margin-left:8px;font-family:'JetBrains Mono',monospace}
    .delta-up{background:rgba(61,214,140,0.15);color:var(--green)}
    .delta-down{background:rgba(232,69,60,0.15);color:var(--red)}
    
    /* CSV UPLOAD */
    .upload-zone{border:2px dashed var(--border);border-radius:14px;padding:48px;text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:20px}
    .upload-zone:hover,.upload-zone.drag{border-color:var(--yellow);background:rgba(245,197,24,0.04)}
    .upload-zone .upload-icon{font-size:2.5rem;margin-bottom:12px}
    .upload-zone h4{font-size:1rem;font-weight:700;margin-bottom:6px}
    .upload-zone p{color:var(--muted);font-size:0.85rem}
    .upload-zone input{display:none}
    .info-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px;font-size:0.85rem}
    .info-box h4{color:var(--yellow);margin-bottom:10px;font-size:0.9rem}
    .info-box code{background:#1a1a1a;padding:2px 6px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:var(--green)}
    .action-btn{padding:10px 22px;border-radius:8px;border:none;font-family:'Syne',sans-serif;font-weight:700;font-size:0.88rem;cursor:pointer;transition:opacity 0.2s}
    .action-btn.primary{background:var(--yellow);color:#0c0c0c}
    .action-btn.ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
    .action-btn:hover{opacity:0.85}
    .btn-row{display:flex;gap:10px;margin-top:12px}
    
    /* AUTOMATION */
    .auto-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:28px;margin-bottom:20px}
    .auto-card h3{font-size:1rem;font-weight:800;margin-bottom:6px}
    .auto-card .desc{color:var(--muted);font-size:0.85rem;margin-bottom:20px;line-height:1.6}
    .timeline{display:flex;flex-direction:column;gap:0}
    .tl-item{display:flex;gap:16px;padding:12px 0;border-bottom:1px solid var(--border)}
    .tl-item:last-child{border-bottom:none}
    .tl-dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.9rem;flex-shrink:0;margin-top:2px}
    .tl-content h4{font-size:0.88rem;font-weight:700;margin-bottom:4px}
    .tl-content p{font-size:0.82rem;color:var(--muted);line-height:1.5}
    .copy-link{background:#1a1a1a;border:1px solid var(--border);border-radius:8px;padding:12px 16px;display:flex;align-items:center;gap:10px;margin-top:12px}
    .copy-link code{flex:1;font-family:'JetBrains Mono',monospace;font-size:0.82rem;color:var(--green);word-break:break-all}
    .copy-btn{background:var(--yellow);color:#0c0c0c;border:none;padding:6px 14px;border-radius:6px;font-weight:700;font-size:0.78rem;cursor:pointer;white-space:nowrap}
    
    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px 20px;font-size:0.88rem;display:none;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,0.5)}
    .toast.show{display:flex;align-items:center;gap:10px}
    .toast.success{border-left:3px solid var(--green)}
    .toast.error{border-left:3px solid var(--red)}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><img src="https://www.joinfleek.com/_next/static/media/Logo.6ba37d95.webp" alt="Fleek" style="height:32px;vertical-align:middle;margin-right:10px"/><span style="font-family:'Syne',sans-serif;font-size:0.95rem;font-weight:600;opacity:0.6;color:var(--text)">NPS Dashboard</span></div>
    <div class="topbar-right">
      <a href="/survey" target="_blank" class="survey-link">üìã Survey Form</a>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
    <button class="tab" onclick="showTab('geography')">üåç Geography</button>
    <button class="tab" onclick="showTab('departments')">üè¢ Departments</button>
    <button class="tab" onclick="showTab('history')">üìà History</button>
    <button class="tab" onclick="showTab('upload')">‚¨ÜÔ∏è Upload CSV</button>
    <button class="tab" onclick="showTab('responses')">üìã Responses</button>
    <button class="tab" onclick="showTab('automation')">‚öôÔ∏è Automation</button>
    <button class="tab" onclick="showTab('report')">üìÑ Report</button>
  </div>

  <div class="main">

    <!-- OVERVIEW TAB -->
    <div class="tab-content active" id="tab-overview">
      <div class="filter-bar">
        <label>Period:</label>
        <select id="overviewPeriod" onchange="renderAll()">
          <option value="all">All Time</option>
        </select>
      </div>
      <div class="stats-grid">
        <div class="stat nps"><div class="stat-label">NPS Score</div><div class="stat-value" id="ov-nps">‚Äî</div><div class="stat-sub" id="ov-total">Loading...</div></div>
        <div class="stat pro"><div class="stat-label">Promoters (9-10)</div><div class="stat-value" id="ov-pro">‚Äî</div><div class="stat-sub" id="ov-pro-c">0 responses</div></div>
        <div class="stat pass"><div class="stat-label">Passives (7-8)</div><div class="stat-value" id="ov-pass">‚Äî</div><div class="stat-sub" id="ov-pass-c">0 responses</div></div>
        <div class="stat det"><div class="stat-label">Detractors (0-6)</div><div class="stat-value" id="ov-det">‚Äî</div><div class="stat-sub" id="ov-det-c">0 responses</div></div>
      </div>
      <div class="charts-grid">
        <div class="chart-box"><h3>Score Distribution</h3><canvas id="distChart" height="200"></canvas></div>
        <div class="chart-box"><h3>Segment Breakdown</h3><canvas id="segChart" height="200"></canvas></div>
      </div>
    </div>

    <!-- GEOGRAPHY TAB -->
    <div class="tab-content" id="tab-geography">
      <div class="filter-bar">
        <label>Period:</label>
        <select id="geoPeriod" onchange="renderGeography()">
          <option value="all">All Time</option>
        </select>
      </div>
      <div class="geo-grid" id="geoGrid"></div>
      <div class="charts-grid">
        <div class="chart-box"><h3>NPS by Geography</h3><canvas id="geoNpsChart" height="250"></canvas></div>
        <div class="chart-box"><h3>Response Volume by Zone</h3><canvas id="geoVolChart" height="250"></canvas></div>
      </div>
    </div>

    <!-- DEPARTMENTS TAB -->
    <div class="tab-content" id="tab-departments">
      <div class="filter-bar">
        <label>Period:</label>
        <select id="deptPeriod" onchange="renderDepartments()">
          <option value="all">All Time</option>
        </select>
      </div>
      <div class="dept-grid" id="deptGrid"></div>
      <div class="chart-box"><h3>Department NPS Comparison</h3><canvas id="deptChart" height="200"></canvas></div>
    </div>

    <!-- HISTORY TAB -->
    <div class="tab-content" id="tab-history">
      <div class="charts-grid">
        <div class="chart-box"><h3>NPS Trend Over Time</h3><canvas id="trendChart" height="250"></canvas></div>
        <div class="chart-box"><h3>Response Volume</h3><canvas id="volChart" height="250"></canvas></div>
      </div>
      <div class="table-box" style="margin-top:20px">
        <h3>Period-by-Period Summary</h3>
        <div id="historyTableContainer"></div>
      </div>
    </div>

    <!-- UPLOAD CSV TAB -->
    <div class="tab-content" id="tab-upload">
      <div class="info-box">
        <h4>üìÑ Expected CSV Format</h4>
        <p style="line-height:1.8;color:var(--muted)">
          Headers: <code>seller</code>, <code>score</code>, <code>department</code>, <code>geography</code>, <code>city</code>, <code>comment</code>, <code>period</code><br/>
          Geography values: <code>PK Zone</code> | <code>PK Non-Zone</code> | <code>India</code> | <code>ROW</code><br/>
          Score: 0‚Äì10 integer. Period: e.g. <code>Mar 2026</code>
        </p>
      </div>
      <div class="upload-zone" id="dropZone" onclick="document.getElementById('csvInput').click()">
        <input type="file" id="csvInput" accept=".csv" onchange="handleCSV(this)"/>
        <div class="upload-icon">üìÅ</div>
        <h4>Drop CSV file here or click to browse</h4>
        <p>Accepts .csv files ‚Ä¢ Data appends to existing</p>
      </div>
      <div id="csvPreview"></div>
      <div class="table-box">
        <h3>üìö Upload History</h3>
        <div id="uploadLog"></div>
      </div>
    </div>

    <!-- RESPONSES TAB -->
    <div class="tab-content" id="tab-responses">
      <div class="filter-bar">
        <label>Period:</label>
        <select id="respPeriod" onchange="renderResponses()"><option value="all">All Time</option></select>
        <label>Category:</label>
        <select id="respCat" onchange="renderResponses()">
          <option value="all">All</option>
          <option value="Promoter">Promoters</option>
          <option value="Passive">Passives</option>
          <option value="Detractor">Detractors</option>
        </select>
        <label>Geography:</label>
        <select id="respGeo" onchange="renderResponses()">
          <option value="all">All Zones</option>
          <option value="PK Zone">PK Zone</option>
          <option value="PK Non-Zone">PK Non-Zone</option>
          <option value="India">India</option>
          <option value="ROW">ROW</option>
        </select>
        <button class="action-btn ghost" onclick="exportCSV()">‚¨áÔ∏è Export CSV</button>
      </div>
      <div class="table-box"><div id="responsesTableContainer"></div></div>
    </div>

    <!-- AUTOMATION TAB -->
    <div class="tab-content" id="tab-automation">
      <div class="auto-card">
        <h3>‚öôÔ∏è Monthly Survey Automation</h3>
        <p class="desc">Every month, during the last week, Seller Support distributes the NPS survey link to all active suppliers. Responses flow directly into this dashboard in real-time.</p>
        <div class="timeline">
          <div class="tl-item">
            <div class="tl-dot" style="background:rgba(245,197,24,0.15);color:var(--yellow)">üìÖ</div>
            <div class="tl-content">
              <h4>Week 3 ‚Äî Prepare</h4>
              <p>Seller Support prepares the monthly survey link with the period pre-filled (e.g. <code style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:var(--green)">/survey?period=Mar+2026</code>). Review and update supplier contact list.</p>
            </div>
          </div>
          <div class="tl-item">
            <div class="tl-dot" style="background:rgba(75,158,255,0.15);color:var(--blue)">üì§</div>
            <div class="tl-content">
              <h4>Last Week ‚Äî Distribute</h4>
              <p>Send the survey link to all suppliers via WhatsApp, email, or in-app message. Use the zone-specific link to pre-fill geography if possible. Target: 100+ responses per month.</p>
            </div>
          </div>
          <div class="tl-item">
            <div class="tl-dot" style="background:rgba(61,214,140,0.15);color:var(--green)">üìä</div>
            <div class="tl-content">
              <h4>Month End ‚Äî Review</h4>
              <p>Responses auto-populate in this dashboard under the correct period. Review NPS score, geography breakdown, department scores, and top issues. Share the /view report with leadership.</p>
            </div>
          </div>
          <div class="tl-item">
            <div class="tl-dot" style="background:rgba(232,69,60,0.15);color:var(--red)">üîÑ</div>
            <div class="tl-content">
              <h4>Next Month ‚Äî Repeat</h4>
              <p>Update the survey link period for the next month. The dashboard accumulates historical data automatically across all periods.</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="auto-card">
        <h3>üîó Monthly Survey Links</h3>
        <p class="desc" style="margin-bottom:16px">Share these pre-configured links with suppliers. Each link auto-fills the survey period.</p>
        <div id="surveyLinks"></div>
      </div>
      
      <div class="auto-card">
        <h3>üìä Current Month Status</h3>
        <div id="currentMonthStatus"></div>
      </div>
    </div>


    <!-- REPORT GENERATOR TAB -->
    <div class="tab-content" id="tab-report">
      <div class="auto-card">
        <h3>üìÑ Generate NPS Report</h3>
        <p class="desc">Generate a shareable internal report in the same style as the official Fleek NPS Report. Configure below and click Generate ‚Äî a full HTML report will download instantly, ready to share with leadership.</p>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:24px">
          <div class="field-group">
            <label style="display:block;font-size:0.78rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;font-weight:700">Report Period</label>
            <select id="reportPeriod" style="width:100%;background:#0c0c0c;border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'Syne',sans-serif;font-size:0.9rem;padding:10px 14px;outline:none">
              <option value="all">All Time</option>
            </select>
          </div>
          <div class="field-group">
            <label style="display:block;font-size:0.78rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;font-weight:700">Prepared By</label>
            <input type="text" id="reportAuthor" placeholder="e.g. Seller Support Team" value="Seller Support Team" style="width:100%;background:#0c0c0c;border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'Syne',sans-serif;font-size:0.9rem;padding:10px 14px;outline:none"/>
          </div>
        </div>

        <div style="margin-top:16px">
          <label style="display:block;font-size:0.78rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;font-weight:700">Executive Note <span style="font-size:0.7rem;color:var(--muted);text-transform:none;letter-spacing:0">(optional ‚Äî appears at top of report)</span></label>
          <textarea id="reportNote" placeholder="Add a brief executive summary or key highlights..." style="width:100%;background:#0c0c0c;border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'Syne',sans-serif;font-size:0.9rem;padding:12px 14px;outline:none;resize:vertical;min-height:80px"></textarea>
        </div>

        <div style="display:flex;gap:12px;margin-top:24px;flex-wrap:wrap">
          <button onclick="generateReport()" style="flex:1;min-width:180px;padding:14px 24px;background:var(--yellow);color:#0c0c0c;border:none;border-radius:10px;font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px;cursor:pointer;transition:opacity 0.2s">‚¨á DOWNLOAD REPORT</button>
          <button onclick="previewReport()" style="flex:1;min-width:180px;padding:14px 24px;background:transparent;color:var(--text);border:1.5px solid var(--border);border-radius:10px;font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px;cursor:pointer;transition:all 0.2s">üëÅ PREVIEW REPORT</button>
        </div>
      </div>

      <div class="auto-card">
        <h3>üìã What's Included in the Report</h3>
        <p class="desc">The generated report is a self-contained HTML file with the official Fleek design, matching the format used for leadership presentations.</p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px">
          <div style="background:#0c0c0c;border-radius:10px;padding:14px;border:1px solid var(--border)">
            <div style="color:var(--yellow);font-weight:700;font-size:0.85rem;margin-bottom:6px">üìä NPS Overview</div>
            <p style="color:var(--muted);font-size:0.82rem;line-height:1.5">Overall NPS score, promoter/passive/detractor breakdown with animated counters</p>
          </div>
          <div style="background:#0c0c0c;border-radius:10px;padding:14px;border:1px solid var(--border)">
            <div style="color:var(--yellow);font-weight:700;font-size:0.85rem;margin-bottom:6px">üìà Score Trend</div>
            <p style="color:var(--muted);font-size:0.82rem;line-height:1.5">Month-over-month NPS trend across all historical periods</p>
          </div>
          <div style="background:#0c0c0c;border-radius:10px;padding:14px;border:1px solid var(--border)">
            <div style="color:var(--yellow);font-weight:700;font-size:0.85rem;margin-bottom:6px">üåç Geography Breakdown</div>
            <p style="color:var(--muted);font-size:0.82rem;line-height:1.5">NPS by zone: PK Zone, PK Non-Zone, India, and ROW with response counts</p>
          </div>
          <div style="background:#0c0c0c;border-radius:10px;padding:14px;border:1px solid var(--border)">
            <div style="color:var(--yellow);font-weight:700;font-size:0.85rem;margin-bottom:6px">üè¢ Departments</div>
            <p style="color:var(--muted);font-size:0.82rem;line-height:1.5">NPS score per department with visual progress bars</p>
          </div>
          <div style="background:#0c0c0c;border-radius:10px;padding:14px;border:1px solid var(--border)">
            <div style="color:var(--yellow);font-weight:700;font-size:0.85rem;margin-bottom:6px">üí¨ Top Feedback</div>
            <p style="color:var(--muted);font-size:0.82rem;line-height:1.5">Most common improvement areas and verbatim seller comments</p>
          </div>
          <div style="background:#0c0c0c;border-radius:10px;padding:14px;border:1px solid var(--border)">
            <div style="color:var(--yellow);font-weight:700;font-size:0.85rem;margin-bottom:6px">üîí Shareable</div>
            <p style="color:var(--muted);font-size:0.82rem;line-height:1.5">Single HTML file ‚Äî email it, upload to Drive, or open in any browser</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  if (sessionStorage.getItem('nps_role') !== 'admin' && sessionStorage.getItem('nps_auth') !== 'true') {
    window.location.href = '/';
  }
  
  function logout() {
    sessionStorage.clear();
    window.location.href = '/';
  }

  // =========================================================
  // SEED DATA ‚Äî CORRECTED NPS VALUES
  // Sep 2025: NPS -10 | Nov 2025: NPS +4 | Jan 2026: NPS +2
  // Overall (all combined): NPS -3
  // =========================================================
  
  const DEPTS = ['Seller Support','Quality Check','Payments','Shipping & Logistics','Vendor App','Sales & Visibility'];
  const GEOS = ['PK Zone','PK Non-Zone','India','ROW'];
  
  // Helper to generate entries achieving target NPS
  function makeEntries(period, total, targetNPS, geoWeights) {
    // targetNPS = (pro - det) / total * 100
    // pro - det = targetNPS * total / 100
    const diff = Math.round(targetNPS * total / 100);
    // Assume pass = 20% of total
    const pass = Math.round(total * 0.20);
    const remaining = total - pass;
    const pro = Math.round((remaining + diff) / 2);
    const det = remaining - pro;
    
    const entries = [];
    const sellerNames = [
      'Ahmad Textiles','Bilal Traders','Zara Fashion','Khan Garments','Metro Crafts',
      'Sunrise Exports','City Fabrics','Alpine Traders','Crescent Co','Eagle Imports',
      'Falcon Industries','Galaxy Goods','Horizon Traders','Indus Exports','Jasmine Co',
      'Kohinoor Textiles','Lotus Traders','Maple Goods','Nova Exports','Ocean Trade',
      'Pearl Handicrafts','Quartz Industries','Rainbow Traders','Star Fabrics','Titan Co',
      'Union Traders','Violet Exports','Wave Industries','Xenon Goods','Yellow Stone',
      'Zephyr Traders','Amber Crafts','Blue Moon Co','Cedar Exports','Diamond Trade'
    ];
    
    // Distribute geos proportionally
    const geoList = [];
    geoWeights.forEach(([geo, pct]) => {
      for (let i = 0; i < Math.round(total * pct); i++) geoList.push(geo);
    });
    while (geoList.length < total) geoList.push(geoWeights[0][0]);
    
    const deptComments = {
      'Seller Support': ['Great support team','Response time needs improvement','Very helpful agents','Takes too long to resolve issues','Excellent communication'],
      'Quality Check': ['QC is thorough','Too many rejections without clear reason','Fair process','QC team is strict but fair','Need better feedback on rejections'],
      'Payments': ['Payments always on time','Delayed by 2 weeks last month','Excellent payment reliability','Payment process is confusing','Fast and reliable'],
      'Shipping & Logistics': ['Delivery is fast','Packaging damaged some items','Good logistics overall','Tracking needs improvement','Excellent delivery service'],
      'Vendor App': ['App is easy to use','App crashes frequently','Good features but slow','Need better analytics in app','App has improved a lot'],
      'Sales & Visibility': ['Good visibility on platform','Need more promotional support','Sales have been steady','Want better placement options','Marketing team is responsive']
    };
    
    let idx = 0;
    
    // Add promoters
    for (let i = 0; i < pro; i++) {
      const score = Math.random() > 0.4 ? 10 : 9;
      const dept = DEPTS[i % DEPTS.length];
      const geo = geoList[idx % geoList.length] || 'PK Zone';
      const comments = deptComments[dept];
      entries.push({
        seller: sellerNames[idx % sellerNames.length] + ' ' + (Math.floor(idx/sellerNames.length)+1 > 1 ? Math.floor(idx/sellerNames.length)+1 : ''),
        score, department: dept, geography: geo,
        city: geo === 'PK Zone' ? ['Karachi','Lahore','Islamabad'][i%3] : geo === 'PK Non-Zone' ? ['Faisalabad','Multan','Peshawar'][i%3] : geo === 'India' ? ['Mumbai','Delhi','Bangalore'][i%3] : ['Dubai','London','New York'][i%3],
        comment: comments[i % comments.length], period,
        submittedAt: new Date(2025, period.includes('Sep')?8:period.includes('Nov')?10:0, Math.floor(Math.random()*25)+1).toISOString(),
        source: 'seed'
      });
      idx++;
    }
    
    // Add passives
    for (let i = 0; i < pass; i++) {
      const score = Math.random() > 0.5 ? 8 : 7;
      const dept = DEPTS[(i+2) % DEPTS.length];
      const geo = geoList[idx % geoList.length] || 'PK Zone';
      entries.push({
        seller: sellerNames[idx % sellerNames.length],
        score, department: dept, geography: geo,
        city: geo === 'PK Zone' ? 'Karachi' : geo === 'PK Non-Zone' ? 'Hyderabad' : geo === 'India' ? 'Chennai' : 'Toronto',
        comment: 'Service is okay, could be better', period,
        submittedAt: new Date(2025, period.includes('Sep')?8:period.includes('Nov')?10:0, Math.floor(Math.random()*25)+1).toISOString(),
        source: 'seed'
      });
      idx++;
    }
    
    // Add detractors
    for (let i = 0; i < det; i++) {
      const score = [0,1,2,3,4,5,6][i % 7];
      const dept = DEPTS[(i+4) % DEPTS.length];
      const geo = geoList[idx % geoList.length] || 'PK Zone';
      const negComments = ['Refund policy is unfair','Too many product rejections','Payment delayed for 3 weeks','App is not working properly','Support takes forever to respond','Not satisfied with the service','Will not recommend','Need better communication'];
      entries.push({
        seller: sellerNames[idx % sellerNames.length],
        score, department: dept, geography: geo,
        city: geo === 'PK Zone' ? 'Karachi' : geo === 'PK Non-Zone' ? 'Quetta' : geo === 'India' ? 'Pune' : 'Australia',
        comment: negComments[i % negComments.length], period,
        submittedAt: new Date(2025, period.includes('Sep')?8:period.includes('Nov')?10:0, Math.floor(Math.random()*25)+1).toISOString(),
        source: 'seed'
      });
      idx++;
    }
    
    return entries;
  }
  
  // Sep 2025: 100 total, NPS -10
  // Nov 2025: 100 total, NPS +4
  // Jan 2026: 147 total, NPS +2 (from report)
  // Overall = (all combined): need to verify -> (all_pro - all_det) / all_total * 100 ‚âà -3
  
  const sepEntries  = makeEntries('Sep 2025', 100, -10, [['PK Zone',0.55],['PK Non-Zone',0.25],['India',0.12],['ROW',0.08]]);
  const novEntries  = makeEntries('Nov 2025', 100, 4,   [['PK Zone',0.55],['PK Non-Zone',0.25],['India',0.12],['ROW',0.08]]);
  const janEntries  = makeEntries('Jan 2026', 147, 2,   [['PK Zone',0.50],['PK Non-Zone',0.25],['India',0.15],['ROW',0.10]]);
  
  const SEED_DATA = [...sepEntries, ...novEntries, ...janEntries];
  
  // Load/save data
  function getData() {
    const stored = localStorage.getItem('fleek_nps_v2');
    if (stored) {
      try { return JSON.parse(stored); } catch(e) {}
    }
    localStorage.setItem('fleek_nps_v2', JSON.stringify(SEED_DATA));
    return SEED_DATA;
  }
  
  function saveData(data) {
    localStorage.setItem('fleek_nps_v2', JSON.stringify(data));
  }
  
  let allData = getData();
  
  function calcNPS(entries) {
    const n = entries.length;
    if (!n) return { nps: null, pro: 0, pass: 0, det: 0, total: 0 };
    const pro = entries.filter(e => e.score >= 9).length;
    const pass = entries.filter(e => e.score >= 7 && e.score <= 8).length;
    const det = entries.filter(e => e.score <= 6).length;
    return { nps: Math.round((pro - det) / n * 100), pro, pass, det, total: n };
  }
  
  // Get unique periods sorted chronologically
  function getPeriods() {
    const order = {'Jan':1,'Feb':2,'Mar':3,'Apr':4,'May':5,'Jun':6,'Jul':7,'Aug':8,'Sep':9,'Oct':10,'Nov':11,'Dec':12};
    const set = [...new Set(allData.map(e => e.period))].filter(Boolean);
    return set.sort((a,b) => {
      const [am, ay] = a.split(' '); const [bm, by] = b.split(' ');
      return (parseInt(ay)-parseInt(by)) || (order[am]||0)-(order[bm]||0);
    });
  }
  
  function populateSelects() {
    const periods = getPeriods();
    const selects = document.querySelectorAll('select[id$="Period"],#respPeriod');
    selects.forEach(sel => {
      const cur = sel.value;
      sel.innerHTML = '<option value="all">All Time</option>' + periods.map(p => `<option value="${p}">${p}</option>`).join('');
      if (cur) sel.value = cur;
    });
  }
  
  function filterByPeriod(selectId) {
    const val = document.getElementById(selectId)?.value || 'all';
    return val === 'all' ? allData : allData.filter(e => e.period === val);
  }
  
  // ===================== OVERVIEW =====================
  let distChart, segChart;
  function renderOverview() {
    const data = filterByPeriod('overviewPeriod');
    const { nps, pro, pass, det, total } = calcNPS(data);
    document.getElementById('ov-nps').textContent = total ? nps : '‚Äî';
    document.getElementById('ov-total').textContent = total ? total + ' responses' : 'No data';
    document.getElementById('ov-pro').textContent = total ? Math.round(pro/total*100)+'%' : '‚Äî';
    document.getElementById('ov-pro-c').textContent = pro + ' responses';
    document.getElementById('ov-pass').textContent = total ? Math.round(pass/total*100)+'%' : '‚Äî';
    document.getElementById('ov-pass-c').textContent = pass + ' responses';
    document.getElementById('ov-det').textContent = total ? Math.round(det/total*100)+'%' : '‚Äî';
    document.getElementById('ov-det-c').textContent = det + ' responses';
    
    const dist = Array(11).fill(0);
    data.forEach(e => { if (e.score >= 0 && e.score <= 10) dist[e.score]++; });
    const colors = dist.map((_,i) => i>=9?'#3DD68C':i>=7?'#F59E0B':'#E8453C');
    
    if (distChart) distChart.destroy();
    distChart = new Chart(document.getElementById('distChart'), {
      type:'bar', data: { labels:['0','1','2','3','4','5','6','7','8','9','10'], datasets:[{data:dist,backgroundColor:colors,borderRadius:6,borderSkipped:false}] },
      options:{ plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#1a1a1a'},ticks:{color:'#888'}},y:{beginAtZero:true,grid:{color:'#1a1a1a'},ticks:{color:'#888',stepSize:1}}}}
    });
    
    if (segChart) segChart.destroy();
    segChart = new Chart(document.getElementById('segChart'), {
      type:'doughnut', data: { labels:['Promoters','Passives','Detractors'], datasets:[{data:[pro,pass,det],backgroundColor:['#3DD68C','#F59E0B','#E8453C'],borderWidth:0}] },
      options:{ plugins:{legend:{position:'bottom',labels:{color:'#888',padding:16}}}, cutout:'65%' }
    });
  }
  
  // ===================== GEOGRAPHY =====================
  let geoNpsChart, geoVolChart;
  function renderGeography() {
    const data = filterByPeriod('geoPeriod');
    const zones = ['PK Zone','PK Non-Zone','India','ROW'];
    const flags = {'PK Zone':'üáµüá∞','PK Non-Zone':'üáµüá∞','India':'üáÆüá≥','ROW':'üåç'};
    const zoneData = zones.map(z => {
      const entries = data.filter(e => e.geography === z);
      return { zone: z, ...calcNPS(entries) };
    });
    
    const grid = document.getElementById('geoGrid');
    grid.innerHTML = zoneData.map(z => {
      const npsClass = z.nps > 0 ? 'positive' : z.nps === 0 ? 'zero' : 'negative';
      const proP = z.total ? Math.round(z.pro/z.total*100) : 0;
      const passP = z.total ? Math.round(z.pass/z.total*100) : 0;
      const detP = z.total ? Math.round(z.det/z.total*100) : 0;
      return `<div class="geo-card">
        <div class="geo-flag">${flags[z.zone]}</div>
        <div class="geo-name">${z.zone}</div>
        <div class="geo-nps ${npsClass}">${z.total ? (z.nps > 0 ? '+' : '') + z.nps : 'N/A'}</div>
        <div class="geo-segs">
          <div class="geo-seg"><span class="seg-label" style="color:#3DD68C">PRO</span><span class="seg-val" style="color:#3DD68C">${proP}%</span></div>
          <div class="geo-seg"><span class="seg-label" style="color:#F59E0B">PAS</span><span class="seg-val" style="color:#F59E0B">${passP}%</span></div>
          <div class="geo-seg"><span class="seg-label" style="color:#E8453C">DET</span><span class="seg-val" style="color:#E8453C">${detP}%</span></div>
          <div class="geo-seg"><span class="seg-label">Total</span><span class="seg-val">${z.total}</span></div>
        </div>
      </div>`;
    }).join('');
    
    if (geoNpsChart) geoNpsChart.destroy();
    geoNpsChart = new Chart(document.getElementById('geoNpsChart'), {
      type: 'bar',
      data: { labels: zones, datasets:[{data:zoneData.map(z=>z.nps||0),backgroundColor:zoneData.map(z=>(z.nps||0)>0?'#3DD68C':'#E8453C'),borderRadius:6,borderSkipped:false}] },
      options: { plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#1a1a1a'},ticks:{color:'#888'}},y:{grid:{color:'#1a1a1a'},ticks:{color:'#888'}}},indexAxis:'y' }
    });
    
    if (geoVolChart) geoVolChart.destroy();
    geoVolChart = new Chart(document.getElementById('geoVolChart'), {
      type:'doughnut', data:{ labels:zones, datasets:[{data:zoneData.map(z=>z.total),backgroundColor:['#F5C518','#4B9EFF','#3DD68C','#F59E0B'],borderWidth:0}] },
      options:{ plugins:{legend:{position:'bottom',labels:{color:'#888',padding:12}}}, cutout:'55%' }
    });
  }
  
  // ===================== DEPARTMENTS =====================
  let deptChart;
  function renderDepartments() {
    const data = filterByPeriod('deptPeriod');
    const deptData = DEPTS.map(d => {
      const entries = data.filter(e => e.department === d);
      return { dept: d, ...calcNPS(entries) };
    }).filter(d => d.total > 0);
    
    document.getElementById('deptGrid').innerHTML = deptData.map(d => {
      const npsClass = d.nps > 0 ? 'positive' : d.nps === 0 ? 'zero' : 'negative';
      const barColor = d.nps > 0 ? '#3DD68C' : '#E8453C';
      const barW = Math.min(100, Math.abs(d.nps));
      return `<div class="dept-card">
        <div class="dept-name">${d.dept}</div>
        <div class="dept-nps ${npsClass}">${d.nps > 0 ? '+' : ''}${d.nps}</div>
        <div class="dept-bar-bg"><div class="dept-bar-fill" style="width:${barW}%;background:${barColor}"></div></div>
        <div class="dept-meta"><span>${d.total} responses</span><span>${Math.round(d.pro/d.total*100)}% promoters</span></div>
      </div>`;
    }).join('');
    
    if (deptChart) deptChart.destroy();
    deptChart = new Chart(document.getElementById('deptChart'), {
      type:'bar', 
      data:{ labels:deptData.map(d=>d.dept.replace(' & ',' &\n')), datasets:[{data:deptData.map(d=>d.nps),backgroundColor:deptData.map(d=>(d.nps||0)>0?'rgba(61,214,140,0.7)':'rgba(232,69,60,0.7)'),borderRadius:6,borderSkipped:false}] },
      options:{ plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#1a1a1a'},ticks:{color:'#888',maxRotation:30}},y:{grid:{color:'#1a1a1a'},ticks:{color:'#888'}}}}
    });
  }
  
  // ===================== HISTORY =====================
  let trendChart, volChart;
  function renderHistory() {
    const periods = getPeriods();
    const periodStats = periods.map(p => {
      const entries = allData.filter(e => e.period === p);
      return { period: p, ...calcNPS(entries) };
    });
    
    if (trendChart) trendChart.destroy();
    trendChart = new Chart(document.getElementById('trendChart'), {
      type:'line',
      data:{ labels:periodStats.map(p=>p.period), datasets:[{label:'NPS',data:periodStats.map(p=>p.nps),borderColor:'#F5C518',backgroundColor:'rgba(245,197,24,0.1)',borderWidth:2.5,pointBackgroundColor:'#F5C518',pointRadius:6,tension:0.3,fill:true}] },
      options:{ plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#1a1a1a'},ticks:{color:'#888'}},y:{grid:{color:'#1a1a1a'},ticks:{color:'#888'}}}}
    });
    
    if (volChart) volChart.destroy();
    volChart = new Chart(document.getElementById('volChart'), {
      type:'bar',
      data:{ labels:periodStats.map(p=>p.period), datasets:[{label:'Responses',data:periodStats.map(p=>p.total),backgroundColor:'rgba(75,158,255,0.6)',borderRadius:6,borderSkipped:false}] },
      options:{ plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#1a1a1a'},ticks:{color:'#888'}},y:{beginAtZero:true,grid:{color:'#1a1a1a'},ticks:{color:'#888'}}}}
    });
    
    // Table
    const rows = periodStats.map((p, i) => {
      const prev = periodStats[i-1];
      const delta = prev ? p.nps - prev.nps : null;
      const npsClass = p.nps > 0 ? 'p' : p.nps < 0 ? 'n' : 'z';
      const deltaHTML = delta !== null ? `<span class="delta-chip ${delta >= 0 ? 'delta-up':'delta-down'}">${delta >= 0 ? '+':''}${delta}</span>` : '';
      return `<tr>
        <td style="font-weight:700">${p.period}</td>
        <td><span class="nps-trend ${npsClass}">${p.nps > 0 ? '+':''}${p.nps}</span>${deltaHTML}</td>
        <td>${p.total}</td>
        <td style="color:#3DD68C">${p.pro} (${Math.round(p.pro/p.total*100)}%)</td>
        <td style="color:#F59E0B">${p.pass} (${Math.round(p.pass/p.total*100)}%)</td>
        <td style="color:#E8453C">${p.det} (${Math.round(p.det/p.total*100)}%)</td>
      </tr>`;
    }).join('');
    
    document.getElementById('historyTableContainer').innerHTML = `<table class="history-table">
      <thead><tr><th>Period</th><th>NPS</th><th>Total</th><th>Promoters</th><th>Passives</th><th>Detractors</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  }
  
  // ===================== RESPONSES =====================
  function renderResponses() {
    const period = document.getElementById('respPeriod').value;
    const cat = document.getElementById('respCat').value;
    const geo = document.getElementById('respGeo').value;
    
    let data = period === 'all' ? allData : allData.filter(e => e.period === period);
    if (geo !== 'all') data = data.filter(e => e.geography === geo);
    if (cat !== 'all') {
      if (cat === 'Promoter') data = data.filter(e => e.score >= 9);
      else if (cat === 'Passive') data = data.filter(e => e.score >= 7 && e.score <= 8);
      else data = data.filter(e => e.score <= 6);
    }
    
    if (!data.length) {
      document.getElementById('responsesTableContainer').innerHTML = '<p style="padding:40px;text-align:center;color:var(--muted)">No responses match the selected filters.</p>';
      return;
    }
    
    const rows = data.map(e => {
      const cat = e.score >= 9 ? 'P' : e.score >= 7 ? 'S' : 'D';
      const catLabel = e.score >= 9 ? 'Promoter' : e.score >= 7 ? 'Passive' : 'Detractor';
      return `<tr>
        <td style="font-weight:600">${e.seller || '‚Äî'}</td>
        <td><span class="score-pill ${cat}">${e.score}</span></td>
        <td><span class="badge ${cat}">${catLabel}</span></td>
        <td style="color:#888">${e.department || '‚Äî'}</td>
        <td style="color:#4B9EFF;font-weight:600">${e.geography || '‚Äî'}</td>
        <td style="color:#888">${e.city || '‚Äî'}</td>
        <td style="color:var(--muted);font-size:0.82rem;max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${e.comment}">${e.comment || '‚Äî'}</td>
        <td style="color:var(--muted);font-size:0.82rem">${e.period || '‚Äî'}</td>
      </tr>`;
    }).join('');
    
    document.getElementById('responsesTableContainer').innerHTML = `<table>
      <thead><tr><th>Seller</th><th>Score</th><th>Category</th><th>Dept</th><th>Geography</th><th>City</th><th>Comment</th><th>Period</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  }
  
  function exportCSV() {
    const data = allData;
    const headers = ['seller','score','category','department','geography','city','comment','period','submittedAt'];
    const rows = data.map(e => [
      e.seller, e.score,
      e.score >= 9 ? 'Promoter' : e.score >= 7 ? 'Passive' : 'Detractor',
      e.department, e.geography, e.city, `"${(e.comment||'').replace(/"/g,'""')}"`, e.period, e.submittedAt
    ].join(','));
    const csv = [headers.join(','), ...rows].join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    a.download = 'fleek_nps_export.csv';
    a.click();
  }
  
  // ===================== CSV UPLOAD =====================
  const dropZone = document.getElementById('dropZone');
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('drag');
    handleCSV({ files: e.dataTransfer.files });
  });
  
  function handleCSV(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const lines = ev.target.result.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/[^a-z]/g,''));
      const idxOf = k => headers.findIndex(h => h.includes(k));
      
      const si = idxOf('seller') >= 0 ? idxOf('seller') : idxOf('name') >= 0 ? idxOf('name') : idxOf('vendor');
      const sci = idxOf('score');
      const di = idxOf('dept');
      const gi = idxOf('geo');
      const ci = idxOf('city');
      const coi = idxOf('comment') >= 0 ? idxOf('comment') : idxOf('feedback');
      const pi = idxOf('period') >= 0 ? idxOf('period') : idxOf('month');
      
      const parsed = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',');
        const score = parseInt(cols[sci]);
        if (isNaN(score) || score < 0 || score > 10) continue;
        parsed.push({
          seller: si >= 0 ? cols[si]?.trim() : 'Unknown',
          score,
          department: di >= 0 ? cols[di]?.trim() : '',
          geography: gi >= 0 ? cols[gi]?.trim() : '',
          city: ci >= 0 ? cols[ci]?.trim() : '',
          comment: coi >= 0 ? cols[coi]?.trim() : '',
          period: pi >= 0 ? cols[pi]?.trim() : getCurrentPeriod(),
          submittedAt: new Date().toISOString(),
          source: 'csv_upload'
        });
      }
      
      if (!parsed.length) {
        showToast('No valid rows found in CSV', 'error');
        return;
      }
      
      const { nps } = calcNPS(parsed);
      const preview = parsed.slice(0,5).map(e => `<tr><td>${e.seller}</td><td>${e.score}</td><td>${e.geography}</td><td>${e.department}</td><td>${e.period}</td></tr>`).join('');
      document.getElementById('csvPreview').innerHTML = `
        <div class="info-box">
          <h4>üìã Preview ‚Äî ${parsed.length} valid rows found ¬∑ NPS: ${nps > 0 ? '+':''}${nps}</h4>
          <table style="width:100%;margin-top:12px"><thead><tr><th>Seller</th><th>Score</th><th>Geography</th><th>Dept</th><th>Period</th></tr></thead><tbody>${preview}</tbody></table>
          ${parsed.length > 5 ? `<p style="color:var(--muted);margin-top:8px;font-size:0.8rem">... and ${parsed.length - 5} more rows</p>` : ''}
          <div class="btn-row">
            <button class="action-btn primary" onclick='importCSV(${JSON.stringify(parsed).replace(/</g,"&lt;")})'>‚úÖ Import ${parsed.length} Rows</button>
            <button class="action-btn ghost" onclick="document.getElementById('csvPreview').innerHTML=''">Cancel</button>
          </div>
        </div>`;
    };
    reader.readAsText(file);
  }
  
  function importCSV(rows) {
    allData = [...allData, ...rows];
    saveData(allData);
    
    // Log upload
    const log = JSON.parse(localStorage.getItem('fleek_upload_log') || '[]');
    const { nps } = calcNPS(rows);
    log.unshift({ file: 'upload_' + Date.now() + '.csv', rows: rows.length, nps, period: rows[0]?.period || '‚Äî', ts: new Date().toLocaleString() });
    localStorage.setItem('fleek_upload_log', JSON.stringify(log));
    
    document.getElementById('csvPreview').innerHTML = '';
    populateSelects();
    renderUploadLog();
    showToast('‚úÖ ' + rows.length + ' responses imported!', 'success');
  }
  
  function renderUploadLog() {
    const log = JSON.parse(localStorage.getItem('fleek_upload_log') || '[]');
    if (!log.length) {
      document.getElementById('uploadLog').innerHTML = '<p style="padding:20px;color:var(--muted);text-align:center">No uploads yet.</p>';
      return;
    }
    const rows = log.map(l => `<tr><td>${l.file}</td><td>${l.rows}</td><td style="color:${(l.nps||0)>=0?'#3DD68C':'#E8453C'}">${(l.nps||0)>0?'+':''}${l.nps||0}</td><td>${l.period}</td><td style="color:var(--muted)">${l.ts}</td></tr>`).join('');
    document.getElementById('uploadLog').innerHTML = `<table><thead><tr><th>File</th><th>Rows</th><th>NPS</th><th>Period</th><th>Timestamp</th></tr></thead><tbody>${rows}</tbody></table>`;
  }
  
  function getCurrentPeriod() {
    return new Date().toLocaleString('en-US', { month: 'short', year: 'numeric' });
  }
  
  // ===================== AUTOMATION =====================
  function renderAutomation() {
    const base = window.location.origin + '/survey';
    const months = [];
    const now = new Date();
    for (let i = 0; i < 4; i++) {
      const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
      const label = d.toLocaleString('en-US', { month: 'short', year: 'numeric' });
      months.push(label);
    }
    
    document.getElementById('surveyLinks').innerHTML = months.map((m, i) => `
      <div class="copy-link" style="margin-bottom:10px">
        <span style="color:var(--muted);font-size:0.8rem;min-width:80px">${m}${i===0?' (now)':''}</span>
        <code>${base}?period=${encodeURIComponent(m)}</code>
        <button class="copy-btn" onclick="copyLink('${base}?period=${encodeURIComponent(m)}')">Copy</button>
      </div>
    `).join('');
    
    const curPeriod = getCurrentPeriod();
    const curData = allData.filter(e => e.period === curPeriod);
    const { nps, total, pro, det } = calcNPS(curData);
    const status = total > 0
      ? `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px">
          <div class="stat nps" style="padding:16px"><div class="stat-label">Current NPS</div><div class="stat-value" style="font-size:1.8rem">${nps > 0 ? '+':''}${nps}</div></div>
          <div class="stat pro" style="padding:16px"><div class="stat-label">Responses</div><div class="stat-value" style="font-size:1.8rem">${total}</div></div>
        </div>
        <p style="color:var(--muted);margin-top:12px;font-size:0.85rem">Survey period: <strong style="color:var(--text)">${curPeriod}</strong></p>`
      : `<p style="color:var(--muted)">No responses yet for <strong style="color:var(--yellow)">${curPeriod}</strong>. Share the survey link above to start collecting!</p>`;
    
    document.getElementById('currentMonthStatus').innerHTML = status;
  }
  
  function copyLink(url) {
    navigator.clipboard.writeText(url).then(() => showToast('üîó Link copied!', 'success'));
  }
  
  // ===================== TOAST =====================
  function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast show ' + type;
    setTimeout(() => t.classList.remove('show'), 3000);
  }
  
  // ===================== TABS =====================
  function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + id).classList.add('active');
    document.querySelectorAll('.tab')[['overview','geography','departments','history','upload','responses','automation','report'].indexOf(id)]?.classList.add('active');
    if (id === 'overview') renderOverview();
    else if (id === 'geography') renderGeography();
    else if (id === 'departments') renderDepartments();
    else if (id === 'history') renderHistory();
    else if (id === 'upload') renderUploadLog();
    else if (id === 'responses') renderResponses();
    else if (id === 'automation') renderAutomation();
    else if (id === 'report') renderReport();
  }
  
  // ===================== INIT =====================
  function renderAll() {
    const active = document.querySelector('.tab-content.active')?.id?.replace('tab-','');
    if (active) showTab(active);
  }
  

  // ===================== REPORT GENERATOR =====================
  function renderReport() {
    const allData = getAll();
    const periods = [...new Set(allData.map(e => e.period))].sort();
    const sel = document.getElementById('reportPeriod');
    if (!sel) return;
    sel.innerHTML = '<option value="all">All Time</option>' + 
      periods.map(p => `<option value="${p}">${p}</option>`).join('');
  }

  function buildReportHTML(periodFilter, title, subtitle, includeGeo, includeDept) {
    const allData = getAll();
    const filtered = periodFilter === 'all' ? allData : allData.filter(e => e.period === periodFilter);
    const { nps, total, pro, pass, det } = calcNPS(filtered);
    
    const proCount = filtered.filter(e => e.score >= 9).length;
    const passCount = filtered.filter(e => e.score >= 7 && e.score <= 8).length;
    const detCount = filtered.filter(e => e.score <= 6).length;
    const proP = total ? Math.round(proCount/total*100) : 0;
    const passP = total ? Math.round(passCount/total*100) : 0;
    const detP = total ? Math.round(detCount/total*100) : 0;
    
    // Dept breakdown
    const depts = ['Seller Support','Quality Check','Payments','Shipping & Logistics','Vendor App','Sales & Visibility'];
    const deptRows = depts.map(dept => {
      const d = filtered.filter(e => e.department === dept);
      if (!d.length) return '';
      const n = calcNPS(d);
      return `<tr><td>${dept}</td><td>${n.total}</td><td>${n.nps > 0 ? '+' : ''}${n.nps}</td><td>${Math.round(d.filter(e=>e.score>=9).length/n.total*100)}%</td><td>${Math.round(d.filter(e=>e.score<=6).length/n.total*100)}%</td></tr>`;
    }).filter(Boolean).join('');

    // Geo breakdown
    const zones = ['PK Zone','PK Non-Zone','India','ROW'];
    const geoRows = zones.map(zone => {
      const d = filtered.filter(e => e.geography === zone);
      if (!d.length) return '';
      const n = calcNPS(d);
      return `<tr><td>${zone}</td><td>${n.total}</td><td>${n.nps > 0 ? '+' : ''}${n.nps}</td><td>${Math.round(d.filter(e=>e.score>=9).length/n.total*100)}%</td><td>${Math.round(d.filter(e=>e.score<=6).length/n.total*100)}%</td></tr>`;
    }).filter(Boolean).join('');

    // History
    const periods = [...new Set(allData.map(e => e.period))].sort();
    const histRows = periods.map(p => {
      const d = allData.filter(e => e.period === p);
      const n = calcNPS(d);
      return `<tr><td>${p}</td><td>${n.total}</td><td style="font-weight:700;color:${n.nps >= 0 ? '#3DD68C' : '#E8453C'}">${n.nps > 0 ? '+' : ''}${n.nps}</td></tr>`;
    }).join('');

    const npsColor = nps >= 0 ? '#3DD68C' : '#E8453C';
    const now = new Date().toLocaleDateString('en-GB', { day:'2-digit', month:'long', year:'numeric' });

    return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>${title || 'Fleek NPS Report'}</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0c0c0c;color:#f0f0f0;font-family:'Syne',sans-serif;padding:40px 24px;max-width:900px;margin:0 auto}
.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:40px;padding-bottom:24px;border-bottom:1px solid #252525}
.logo-area img{height:36px;filter:brightness(0) invert(1)}
.report-meta{text-align:right}
.report-title{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:3px;color:#F5C518}
.report-sub{color:#888;font-size:0.8rem;margin-top:4px}
.hero{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px;margin-bottom:32px}
.metric-card{background:#161616;border:1px solid #252525;border-radius:14px;padding:20px;text-align:center}
.metric-label{font-size:0.7rem;letter-spacing:2px;text-transform:uppercase;color:#888;margin-bottom:8px}
.metric-value{font-family:'Bebas Neue',sans-serif;font-size:2.4rem;letter-spacing:2px}
.nps-val{color:#F5C518}
.pro-val{color:#3DD68C}
.det-val{color:#E8453C}
.pass-val{color:#F59E0B}
.section{background:#161616;border:1px solid #252525;border-radius:14px;padding:24px;margin-bottom:20px}
.section-title{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;color:#F5C518;margin-bottom:16px}
table{width:100%;border-collapse:collapse;font-size:0.88rem}
th{text-align:left;padding:8px 12px;border-bottom:1px solid #252525;font-size:0.7rem;letter-spacing:1.5px;text-transform:uppercase;color:#888;font-weight:600}
td{padding:10px 12px;border-bottom:1px solid #181818;color:#f0f0f0}
tr:last-child td{border-bottom:none}
.bar-wrap{background:#1e1e1e;border-radius:6px;height:10px;overflow:hidden;margin-top:12px}
.bar-fill{height:100%;border-radius:6px;transition:width 0.5s}
.bar-row{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
.bar-label{font-size:0.82rem;min-width:100px;color:#888}
.bar-val{font-size:0.82rem;font-weight:700;min-width:40px;text-align:right}
.footer{margin-top:40px;padding-top:20px;border-top:1px solid #252525;display:flex;justify-content:space-between;align-items:center;color:#555;font-size:0.75rem}
.internal-badge{background:rgba(245,197,24,0.1);border:1px solid rgba(245,197,24,0.2);color:#F5C518;padding:4px 12px;border-radius:6px;font-size:0.7rem;letter-spacing:1px}
@media print{body{background:#fff;color:#000}.metric-card,.section{background:#f8f8f8;border-color:#ddd}.metric-label,.section-title,.report-sub,.bar-label,.footer{color:#555}th{color:#555}td{color:#222}}
</style>
</head>
<body>
<div class="header">
  <div class="logo-area">
    <img src="https://www.joinfleek.com/_next/static/media/Logo.6ba37d95.webp" alt="Fleek"/>
    <div style="font-size:0.7rem;letter-spacing:2px;color:#888;margin-top:6px;text-transform:uppercase">Seller Experience</div>
  </div>
  <div class="report-meta">
    <div class="report-title">${title || 'NPS REPORT'}</div>
    <div class="report-sub">${subtitle || ''}</div>
    <div class="report-sub">Generated: ${now}</div>
    <span class="internal-badge">INTERNAL</span>
  </div>
</div>

<div class="hero">
  <div class="metric-card"><div class="metric-label">Overall NPS</div><div class="metric-value nps-val" style="color:${npsColor}">${nps > 0 ? '+' : ''}${nps}</div></div>
  <div class="metric-card"><div class="metric-label">Promoters</div><div class="metric-value pro-val">${proP}%</div></div>
  <div class="metric-card"><div class="metric-label">Passives</div><div class="metric-value pass-val">${passP}%</div></div>
  <div class="metric-card"><div class="metric-label">Detractors</div><div class="metric-value det-val">${detP}%</div></div>
</div>

<div class="section">
  <div class="section-title">Score Distribution</div>
  <div class="bar-row"><span class="bar-label">Promoters (9‚Äì10)</span><div style="flex:1"><div class="bar-wrap"><div class="bar-fill" style="width:${proP}%;background:#3DD68C"></div></div></div><span class="bar-val" style="color:#3DD68C">${proP}%</span></div>
  <div class="bar-row"><span class="bar-label">Passives (7‚Äì8)</span><div style="flex:1"><div class="bar-wrap"><div class="bar-fill" style="width:${passP}%;background:#F59E0B"></div></div></div><span class="bar-val" style="color:#F59E0B">${passP}%</span></div>
  <div class="bar-row"><span class="bar-label">Detractors (0‚Äì6)</span><div style="flex:1"><div class="bar-wrap"><div class="bar-fill" style="width:${detP}%;background:#E8453C"></div></div></div><span class="bar-val" style="color:#E8453C">${detP}%</span></div>
  <div style="margin-top:16px;color:#888;font-size:0.82rem">Total responses: <strong style="color:#f0f0f0">${total}</strong> &nbsp;¬∑&nbsp; Period: <strong style="color:#F5C518">${periodFilter === 'all' ? 'All Time' : periodFilter}</strong></div>
</div>

${histRows ? `<div class="section">
  <div class="section-title">Historical Trend</div>
  <table><thead><tr><th>Period</th><th>Responses</th><th>NPS</th></tr></thead><tbody>${histRows}</tbody></table>
</div>` : ''}

${includeDept && deptRows ? `<div class="section">
  <div class="section-title">By Department</div>
  <table><thead><tr><th>Department</th><th>Responses</th><th>NPS</th><th>Promoters</th><th>Detractors</th></tr></thead><tbody>${deptRows}</tbody></table>
</div>` : ''}

${includeGeo && geoRows ? `<div class="section">
  <div class="section-title">By Geography</div>
  <table><thead><tr><th>Zone</th><th>Responses</th><th>NPS</th><th>Promoters</th><th>Detractors</th></tr></thead><tbody>${geoRows}</tbody></table>
</div>` : ''}

<div class="footer">
  <span>Fleek Seller Experience ¬∑ Internal Report ¬∑ Confidential</span>
  <span>${now}</span>
</div>
</body>
</html>`;
  }

  function generateReport() {
    const periodFilter = document.getElementById('reportPeriod')?.value || 'all';
    const title = 'NPS REPORT';
    const subtitle = document.getElementById('reportAuthor')?.value || 'Seller Support Team';
    const includeGeo = true;
    const includeDept = true;
    
    const html = buildReportHTML(periodFilter, title, subtitle, includeGeo, includeDept);
    const blob = new Blob([html], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const period = periodFilter === 'all' ? 'AllTime' : periodFilter.replace(' ','_');
    a.download = `Fleek_NPS_Report_${period}.html`;
    a.click();
    showToast('üìÑ Report downloaded!', 'success');
  }
  
  function previewReport() {
    const periodFilter = document.getElementById('reportPeriod')?.value || 'all';
    const title = 'NPS REPORT';
    const subtitle = document.getElementById('reportAuthor')?.value || 'Seller Support Team';
    const includeGeo = true;
    const includeDept = true;
    
    const html = buildReportHTML(periodFilter, title, subtitle, includeGeo, includeDept);
    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
  }

  populateSelects();
  renderOverview();
  renderUploadLog();
</script>
</body>
</html>
