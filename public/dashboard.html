<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fleek NPS Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI',sans-serif;background:#f8fafc;color:#1e293b}
    .topbar{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:16px 32px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 12px rgba(102,126,234,0.3)}
    .topbar .brand{font-size:1.4rem;font-weight:900;letter-spacing:-0.5px}
    .topbar .logout{background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 18px;border-radius:8px;cursor:pointer;font-size:0.9rem;font-weight:600}
    .topbar .logout:hover{background:rgba(255,255,255,0.3)}
    .main{padding:32px;max-width:1200px;margin:0 auto}
    h1{font-size:1.8rem;font-weight:800;margin-bottom:4px}
    .sub{color:#64748b;margin-bottom:28px;font-size:0.95rem}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:32px}
    .stat-card{background:#fff;border-radius:16px;padding:24px;box-shadow:0 1px 8px rgba(0,0,0,0.06);border-left:4px solid transparent}
    .stat-card.promoters{border-left-color:#10b981}
    .stat-card.passives{border-left-color:#f59e0b}
    .stat-card.detractors{border-left-color:#ef4444}
    .stat-card.nps{border-left-color:#667eea}
    .stat-card .label{font-size:0.8rem;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;color:#94a3b8;margin-bottom:8px}
    .stat-card .value{font-size:2.4rem;font-weight:900;line-height:1}
    .stat-card.promoters .value{color:#10b981}
    .stat-card.passives .value{color:#f59e0b}
    .stat-card.detractors .value{color:#ef4444}
    .stat-card.nps .value{color:#667eea}
    .stat-card .count{font-size:0.85rem;color:#94a3b8;margin-top:4px}
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:32px}
    @media(max-width:768px){.charts{grid-template-columns:1fr}}
    .chart-card{background:#fff;border-radius:16px;padding:24px;box-shadow:0 1px 8px rgba(0,0,0,0.06)}
    .chart-card h3{font-size:1rem;font-weight:700;margin-bottom:20px;color:#374151}
    .responses-table{background:#fff;border-radius:16px;padding:24px;box-shadow:0 1px 8px rgba(0,0,0,0.06);margin-bottom:32px}
    .responses-table h3{font-size:1rem;font-weight:700;margin-bottom:16px;color:#374151}
    table{width:100%;border-collapse:collapse}
    th{text-align:left;font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:#94a3b8;padding:10px 12px;border-bottom:2px solid #f1f5f9}
    td{padding:12px;border-bottom:1px solid #f8fafc;font-size:0.9rem}
    tr:last-child td{border-bottom:none}
    tr:hover td{background:#f8fafc}
    .badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:0.75rem;font-weight:700}
    .badge.promoter{background:#d1fae5;color:#065f46}
    .badge.passive{background:#fef3c7;color:#92400e}
    .badge.detractor{background:#fee2e2;color:#991b1b}
    .score-bar{display:inline-flex;align-items:center;gap:8px}
    .score-dot{width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-weight:800;font-size:0.85rem;color:#fff}
    .add-form{background:#fff;border-radius:16px;padding:24px;box-shadow:0 1px 8px rgba(0,0,0,0.06);margin-bottom:32px}
    .add-form h3{font-size:1rem;font-weight:700;margin-bottom:16px;color:#374151}
    .form-row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .form-group{display:flex;flex-direction:column;gap:6px;flex:1;min-width:140px}
    .form-group label{font-size:0.8rem;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:0.5px}
    .form-group input,.form-group select,.form-group textarea{padding:10px 14px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:0.9rem;outline:none;transition:border-color 0.2s;font-family:inherit}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:#667eea}
    .form-group textarea{resize:vertical;min-height:60px}
    .submit-btn{padding:11px 28px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;font-size:0.9rem;font-weight:700;cursor:pointer;white-space:nowrap}
    .submit-btn:hover{opacity:0.9}
    .empty{text-align:center;padding:40px;color:#94a3b8;font-size:0.95rem}
    .refresh-btn{background:#f1f5f9;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:0.85rem;font-weight:600;color:#475569;margin-left:12px}
    .refresh-btn:hover{background:#e2e8f0}
    .header-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">‚ö° Fleek NPS Dashboard</div>
    <button class="logout" onclick="logout()">Logout</button>
  </div>
  <div class="main">
    <div class="header-row">
      <div>
        <h1>NPS Overview</h1>
        <p class="sub">Net Promoter Score analytics & response tracker</p>
      </div>
      <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat-card nps">
        <div class="label">NPS Score</div>
        <div class="value" id="nps-score">‚Äî</div>
        <div class="count" id="nps-total">No responses yet</div>
      </div>
      <div class="stat-card promoters">
        <div class="label">Promoters (9-10)</div>
        <div class="value" id="promoters-pct">‚Äî</div>
        <div class="count" id="promoters-count">0 responses</div>
      </div>
      <div class="stat-card passives">
        <div class="label">Passives (7-8)</div>
        <div class="value" id="passives-pct">‚Äî</div>
        <div class="count" id="passives-count">0 responses</div>
      </div>
      <div class="stat-card detractors">
        <div class="label">Detractors (0-6)</div>
        <div class="value" id="detractors-pct">‚Äî</div>
        <div class="count" id="detractors-count">0 responses</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts">
      <div class="chart-card">
        <h3>üìä Score Distribution</h3>
        <canvas id="barChart" height="200"></canvas>
      </div>
      <div class="chart-card">
        <h3>üç© Segment Breakdown</h3>
        <canvas id="doughnutChart" height="200"></canvas>
      </div>
    </div>

    <!-- Add Response Form -->
    <div class="add-form">
      <h3>‚ûï Add NPS Response</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Respondent Name</label>
          <input type="text" id="f-name" placeholder="e.g. John Doe"/>
        </div>
        <div class="form-group">
          <label>Score (0-10)</label>
          <input type="number" id="f-score" min="0" max="10" placeholder="0-10"/>
        </div>
        <div class="form-group" style="flex:2">
          <label>Comment (optional)</label>
          <input type="text" id="f-comment" placeholder="Any feedback..."/>
        </div>
        <button class="submit-btn" onclick="submitResponse()">Submit</button>
      </div>
    </div>

    <!-- Responses Table -->
    <div class="responses-table">
      <h3>üìã All Responses</h3>
      <div id="table-container"><p class="empty">Loading responses...</p></div>
    </div>
  </div>

  <script>
    if(sessionStorage.getItem('nps_auth')!=='true') window.location.href='/';

    function logout(){sessionStorage.removeItem('nps_auth');window.location.href='/';}

    let allResponses = [];

    async function loadData(){
      try{
        const res = await fetch('/api/results');
        const data = await res.json();
        allResponses = data.responses || [];
        renderDashboard(allResponses);
      } catch(e){
        // Use local data if API fails
        renderDashboard(allResponses);
      }
    }

    async function submitResponse(){
      const name = document.getElementById('f-name').value.trim() || 'Anonymous';
      const score = parseInt(document.getElementById('f-score').value);
      const comment = document.getElementById('f-comment').value.trim();
      if(isNaN(score)||score<0||score>10){alert('Please enter a score between 0 and 10.');return;}
      const entry = {name, score, comment, date: new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})};
      try{
        await fetch('/api/submit',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(entry)
        });
      } catch(e){}
      allResponses.unshift(entry);
      renderDashboard(allResponses);
      document.getElementById('f-name').value='';
      document.getElementById('f-score').value='';
      document.getElementById('f-comment').value='';
    }

    let barChart, doughnutChart;

    function renderDashboard(responses){
      const total = responses.length;
      const promoters = responses.filter(r=>r.score>=9).length;
      const passives = responses.filter(r=>r.score>=7&&r.score<=8).length;
      const detractors = responses.filter(r=>r.score<=6).length;
      const nps = total===0 ? 0 : Math.round(((promoters-detractors)/total)*100);

      document.getElementById('nps-score').textContent = total===0 ? '‚Äî' : nps;
      document.getElementById('nps-total').textContent = total===0 ? 'No responses yet' : total+' total responses';
      document.getElementById('promoters-pct').textContent = total===0 ? '‚Äî' : Math.round((promoters/total)*100)+'%';
      document.getElementById('promoters-count').textContent = promoters+' responses';
      document.getElementById('passives-pct').textContent = total===0 ? '‚Äî' : Math.round((passives/total)*100)+'%';
      document.getElementById('passives-count').textContent = passives+' responses';
      document.getElementById('detractors-pct').textContent = total===0 ? '‚Äî' : Math.round((detractors/total)*100)+'%';
      document.getElementById('detractors-count').textContent = detractors+' responses';

      // Score distribution (0-10)
      const dist = Array(11).fill(0);
      responses.forEach(r=>dist[r.score]++);
      const barColors = dist.map((_,i)=>i>=9?'#10b981':i>=7?'#f59e0b':'#ef4444');

      if(barChart) barChart.destroy();
      barChart = new Chart(document.getElementById('barChart'),{
        type:'bar',
        data:{
          labels:['0','1','2','3','4','5','6','7','8','9','10'],
          datasets:[{label:'Responses',data:dist,backgroundColor:barColors,borderRadius:6}]
        },
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}
      });

      if(doughnutChart) doughnutChart.destroy();
      doughnutChart = new Chart(document.getElementById('doughnutChart'),{
        type:'doughnut',
        data:{
          labels:['Promoters','Passives','Detractors'],
          datasets:[{data:[promoters,passives,detractors],backgroundColor:['#10b981','#f59e0b','#ef4444'],borderWidth:0}]
        },
        options:{plugins:{legend:{position:'bottom'}},cutout:'65%'}
      });

      // Table
      const container = document.getElementById('table-container');
      if(responses.length===0){container.innerHTML='<p class="empty">No responses yet. Add the first one above!</p>';return;}
      const rows = responses.map(r=>{
        const cat = r.score>=9?'promoter':r.score>=7?'passive':'detractor';
        const dotColor = r.score>=9?'#10b981':r.score>=7?'#f59e0b':'#ef4444';
        return '<tr><td>'+r.name+'</td><td><span class="score-dot" style="background:'+dotColor+'">'+r.score+'</span></td><td><span class="badge '+cat+'">'+cat.charAt(0).toUpperCase()+cat.slice(1)+'</span></td><td style="color:#64748b">'+( r.comment||'‚Äî')+'</td><td style="color:#94a3b8;font-size:0.8rem">'+r.date+'</td></tr>';
      }).join('');
      container.innerHTML='<table><thead><tr><th>Name</th><th>Score</th><th>Category</th><th>Comment</th><th>Date</th></tr></thead><tbody>'+rows+'</tbody></table>';
    }

    loadData();
  </script>
</body>
</html>